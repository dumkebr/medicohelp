name: Deploy AutomÃ¡tico - Hostinger VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“š Install dependencies
        run: npm ci
      
      - name: ğŸ”¨ Build frontend
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: ğŸ“ Verificar arquivos compilados
        run: |
          echo "=== Arquivos crÃ­ticos compilados ==="
          ls -lh dist/public/assets/index-*.js 2>/dev/null || echo "JS nÃ£o encontrado!"
          ls -lh dist/public/assets/index-*.css 2>/dev/null || echo "CSS nÃ£o encontrado!"
          echo ""
          echo "=== Tamanho total dos assets ==="
          du -sh dist/public/assets/
      
      - name: ğŸ§¹ Limpar VPS antes do deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASS }}
          port: ${{ secrets.SFTP_PORT }}
          script: |
            echo "ğŸ—‘ï¸ Removendo arquivos antigos..."
            rm -rf /var/www/medicohelp/dist/public/*
            mkdir -p /var/www/medicohelp/dist/public/assets
            echo "âœ… VPS limpo e pronto!"
      
      - name: ğŸš€ Deploy via SCP (TODOS os arquivos)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASS }}
          port: ${{ secrets.SFTP_PORT }}
          source: "dist/public/*"
          target: "/var/www/medicohelp/dist/"
          strip_components: 1
          rm: false
          overwrite: true
      
      - name: ğŸ”§ Configurar permissÃµes e reiniciar Nginx
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASS }}
          port: ${{ secrets.SFTP_PORT }}
          script: |
            echo "ğŸ”’ Configurando permissÃµes..."
            chmod -R 755 /var/www/medicohelp
            chown -R www-data:www-data /var/www/medicohelp
            
            echo "ğŸ”„ Reiniciando Nginx..."
            systemctl restart nginx
            
            echo ""
            echo "âœ… Deploy automÃ¡tico concluÃ­do!"
            echo "ğŸ“… Data: $(date)"
      
      - name: âœ… Verificar arquivos crÃ­ticos no VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASS }}
          port: ${{ secrets.SFTP_PORT }}
          script: |
            echo "ğŸ“ Verificando arquivos crÃ­ticos no VPS:"
            echo ""
            JS_SIZE=$(ls -lh /var/www/medicohelp/dist/public/assets/index-*.js 2>/dev/null | awk '{print $5}')
            CSS_SIZE=$(ls -lh /var/www/medicohelp/dist/public/assets/index-*.css 2>/dev/null | awk '{print $5}')
            
            if [ -n "$JS_SIZE" ]; then
              echo "âœ… JavaScript: $JS_SIZE"
            else
              echo "âŒ JavaScript NÃƒO ENCONTRADO!"
            fi
            
            if [ -n "$CSS_SIZE" ]; then
              echo "âœ… CSS: $CSS_SIZE"
            else
              echo "âŒ CSS NÃƒO ENCONTRADO!"
            fi
            
            echo ""
            echo "ğŸ“Š Total de arquivos em assets:"
            ls -la /var/www/medicohelp/dist/public/assets/ | wc -l
      
      - name: ğŸ‰ Deploy finalizado
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… DEPLOY AUTOMÃTICO CONCLUÃDO!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Site: www.medicohelp.com.br"
          echo "ğŸ“… Deploy: $(date)"
          echo ""
          echo "âš ï¸  Limpe o cache do navegador (Ctrl+Shift+R)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
