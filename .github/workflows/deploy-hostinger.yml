name: Deploy Automático - Hostinger VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v3
      
      - name: 📦 Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: 📚 Install dependencies
        run: npm ci
      
      - name: 🔨 Build frontend
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: 📝 Verificar arquivos compilados
        run: |
          echo "=== Arquivos críticos compilados ==="
          ls -lh dist/public/assets/index-*.js 2>/dev/null || echo "JS não encontrado!"
          ls -lh dist/public/assets/index-*.css 2>/dev/null || echo "CSS não encontrado!"
          echo ""
          echo "=== Tamanho total dos assets ==="
          du -sh dist/public/assets/
      
      - name: 🚀 Deploy via SCP (TODOS os arquivos)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASS }}
          port: ${{ secrets.SFTP_PORT }}
          source: "dist/public/*"
          target: "/var/www/medicohelp/dist/"
          strip_components: 1
          rm: false
          overwrite: true
          timeout: 10m
          command_timeout: 10m
      
      - name: 🎉 Deploy finalizado
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ DEPLOY AUTOMÁTICO CONCLUÍDO!"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "🌐 Site: www.medicohelp.com.br"
          echo "📅 Deploy: $(date)"
          echo ""
          echo "⚠️  Limpe o cache do navegador (Ctrl+Shift+R)"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
