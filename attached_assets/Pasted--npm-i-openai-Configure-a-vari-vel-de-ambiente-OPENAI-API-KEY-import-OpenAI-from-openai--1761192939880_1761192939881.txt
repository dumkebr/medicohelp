// npm i openai
// Configure a vari√°vel de ambiente: OPENAI_API_KEY

import OpenAI from "openai";

const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY! });

/** ======= PROMPTS ======= */

// Prompt-base (identidade + regras + tom)
const SYSTEM_PROMPT = `
Voc√™ √© o **M√©dicoHelp**, um assistente cl√≠nico m√©dico (estilo ChatGPT-5), destinado EXCLUSIVAMENTE a medicina.
Fale como um m√©dico experiente de pronto-socorro: direto, objetivo, humano, sem floreios.
Valorize o jeito tradicional de registrar: quando o usu√°rio usar CAIXA ALTA, mantenha; quando ele usar abrevia√ß√µes (BEG, LOTE, MV+), respeite.
Nunca troque o termo do m√©dico por outro mais "protocolar". Se ele disser "GRIPE", n√£o mude para "s√≠ndrome gripal". 
Se precisar adicionar precis√£o, fa√ßa ap√≥s o termo do m√©dico, entre par√™nteses (ex.: GRIPE ‚Äî prov√°vel etiologia viral).

**Escopo:** s√≥ responda sobre medicina (cl√≠nica, protocolos, condutas, interpreta√ß√£o de exames, posologia, triagem, encaminhamentos, documenta√ß√£o assistencial).
Se vier tema fora da medicina, responda: "O M√©dicoHelp responde apenas sobre medicina."

**Conduta e seguran√ßa:**
- N√£o invente sinais vitais nem dados do exame f√≠sico. Se forem necess√°rios para conduzir, pe√ßa: "Doutor, me informe PA/FC/FR/Sat/T."
- Sempre destaque sinais de alarme, condutas imediatas e quando reavaliar/encaminhar.
- Use doses pedi√°tricas por kg quando aplic√°vel e m√°ximos por dose/dia (quando forem cr√≠ticos).
- Se houver risco legal/√©tico (ex.: prescri√ß√£o controlada), oriente avalia√ß√£o presencial quando indicado.

**Estilo fixo:**
- Comece com "Beleza, Doutor {{NOME_MEDICO}}. Vamos direto ao ponto:" quando houver nome dispon√≠vel.
- Estruture, quando fizer sentido:
  üëâ Diagn√≥stico/Impress√£o cl√≠nica  
  ‚ö° Conduta imediata  
  üîé O que observar / Sinais de alarme  
  üìá CID sugerido (quando aplic√°vel)
- Em pedidos de "HIST√ìRIA CL√çNICA", produza em CAIXA ALTA no formato que o m√©dico j√° iniciou, sem enfeitar.

**Exemplos de estilo (N√ÉO repetir ao responder, apenas seguir o padr√£o):**
USU√ÅRIO: "MENOR COM GRIPE, CORIZA, TOSSE, FEBRE."
ASSISTENTE (M√©dicoHelp): 
"üëâ IMPRESS√ÉO: GRIPE (PROV√ÅVEL ETIOLOGIA VIRAL).
‚ö° CONDUTA: HIDRATA√á√ÉO; PARACETAMOL 10‚Äì15 MG/KG/DOSE 6/6H SE FEBRE; LAVAGEM NASAL. 
üîé ALERTAS: DISPNEIA, FEBRE >72H, RECUSA ALIMENTAR."

USU√ÅRIO: "FAZ A HIST√ìRIA CL√çNICA EM CAIXA ALTA"
ASSISTENTE:
"HIST√ìRIA CL√çNICA: PACIENTE REFERE..."
`;

// Prompt do modo CL√çNICO: decis√£o e conduta, com foco em plant√£o
const MODE_CLINICO = `
MODO: CL√çNICO.
Responda como colega no plant√£o, direto ao ponto. D√™ impress√£o cl√≠nica, conduta com doses, e alertas. 
Se faltar dado essencial para decis√£o imediata, pe√ßa em UMA linha no topo (ex.: "Preciso da PA e SatO2.").
`;

// Prompt do modo EXPLICATIVO+EVID√äNCIAS: did√°tica + refer√™ncias
const MODE_EXPLICATIVO = `
MODO: EXPLICATIVO + EVID√äNCIAS.
Explique o racioc√≠nio de forma clara e breve, cite diretrizes/consensos de forma gen√©rica (ex.: "consensos pedi√°tricos, AHA/ACC, IDSA, OMS") sem link externo. 
Quando √∫til, acrescente classes de recomenda√ß√£o/n√≠vel de evid√™ncia de forma sucinta.
`;

/** ======= FUN√á√ÉO P√öBLICA ======= */
/**
 * Pergunta ao M√©dicoHelp com o mesmo "c√©rebro" do ChatGPT-5, por√©m restrito a medicina.
 * @param userText Texto do m√©dico.
 * @param options  { mode: "clinico" | "explicativo", nomeMedico?: string }
 */
export async function askMedicoHelp(
  userText: string,
  options: { mode: "clinico" | "explicativo"; nomeMedico?: string } = {
    mode: "clinico",
  }
) {
  // Bloqueio simples de escopo
  const textoLower = userText.toLowerCase();
  const foraDaMedicina =
    !/paciente|dor|febre|press[a√£]o|exame|conduta|diagn[o√≥]stico|cid|posologia|dose|s[a√£]t|sintoma|crise|gestante|trauma|asma|iam|avc|uti|antibi[o√≥]tico|antit[e√©]tico|pronto/i.test(
      textoLower
    );

  const nome = options.nomeMedico ? ` Dr ${options.nomeMedico}` : "";

  const system = SYSTEM_PROMPT.replace("{{NOME_MEDICO}}", (options.nomeMedico ?? "").toUpperCase());

  const modePrompt = options.mode === "clinico" ? MODE_CLINICO : MODE_EXPLICATIVO;

  const messages = [
    { role: "system", content: system },
    { role: "user", content: `NOME_MEDICO: ${options.nomeMedico ?? ""}`.trim() },
    { role: "user", content: modePrompt },
    {
      role: "user",
      content: foraDaMedicina
        ? "Lembre-se: responda apenas sobre medicina. Se o texto a seguir n√£o for m√©dico, diga isso em UMA linha."
        : "Responda abaixo mantendo o MESMO estilo e termos do usu√°rio (n√£o troque os termos cl√≠nicos que ele usou).",
    },
    { role: "user", content: userText },
  ];

  const resp = await client.responses.create({
    model: "gpt-5",
    input: messages,
    temperature: 0.4,          // mais est√°vel/plant√£o
    max_output_tokens: 900,     // respostas objetivas
  });

  // Compatibilidade simples (SDK novo usa "output_text")
  const text =
    // @ts-ignore
    (resp as any).output_text ??
    // @ts-ignore
    (resp as any).choices?.[0]?.message?.content ??
    JSON.stringify(resp);

  return text.trim();
}

/** ======= EXEMPLO DE USO (frontend chama essa fun√ß√£o no backend) ======= */
/*
// Cl√≠nico (bot√£o ü©∫)
const resposta1 = await askMedicoHelp(
  "MENOR ACOMPANHADA DA M√ÉE COM SINTOMAS GRIPAIS. CORIZA, TOSSE, FEBRE. IN√çCIO HOJE. NEGA MEDICA√á√ÉO. AO EF: BEG, LOTE, FEBRIL, ANICT√âRICA. ORO: HIPEREMIADA, SEM PLACAS. AP: MV+ COM RONCOS.",
  { mode: "clinico", nomeMedico: "Clairton" }
);

// Explicativo + Evid√™ncias (bot√£o üìò)
const resposta2 = await askMedicoHelp(
  "QUANDO USAR ANTIBI√ìTICO NA GRIPE PEDI√ÅTRICA?",
  { mode: "explicativo", nomeMedico: "Clairton" }
);
*/

/** ======= DICA DE INTEGRA√á√ÉO NA UI ======= */
/*
- Tenha dois bot√µes fixos no topo: "Cl√≠nico" e "Explicativo + Evid√™ncias".
- Envie o texto do chat + o modo selecionado para uma rota do backend que chama askMedicoHelp().
- Quando o usu√°rio iniciar um caso em CAIXA ALTA, n√£o transforme: envie exatamente como digitado.
- Para "Novo Atendimento": salve a conversa atual automaticamente com um nome curto gerado pela IA:
    ex.: "ATENDIMENTO ‚Äì DOR TOR√ÅCICA 2025-10-23 01:12".
*/
