export type Mensagem = {
  role: "user" | "assistant";
  content: string;
  ts: string; // ISO
};

export type Atendimento = {
  id: string;
  title: string;
  messages: Mensagem[];
  createdAt: string;
  updatedAt: string;
  mode?: "clinico" | "explicacao";
  patientId?: string | null;   // se tiver paciente, NUNCA expira
  saved?: boolean;             // “Atendimento salvo” (fixado)
};

const KEY = "mh_atendimentos";
const CUR = "mh_current_atendimento_id";
const RETENTION_DAYS = 30; // política: expira em 30 dias se não salvo e sem paciente

function loadAllRaw(): Atendimento[] {
  try { return JSON.parse(localStorage.getItem(KEY) || "[]"); } catch { return []; }
}
function saveAll(list: Atendimento[]) {
  try { localStorage.setItem(KEY, JSON.stringify(list)); } catch {}
}

// Remove atendimentos “voláteis” > 30 dias (sem paciente e não salvos)
function cleanup(list: Atendimento[]): Atendimento[] {
  const now = Date.now();
  const ms = RETENTION_DAYS * 24 * 60 * 60 * 1000;
  return list.filter(a => {
    const keep = !!a.patientId || !!a.saved; // salvos ou com paciente: nunca expiram
    if (keep) return true;
    const age = now - new Date(a.updatedAt || a.createdAt).getTime();
    return age <= ms;
  });
}

export function listAtendimentos(): Atendimento[] {
  const cleaned = cleanup(loadAllRaw());
  if (cleaned.length !== loadAllRaw().length) saveAll(cleaned);
  return cleaned.sort((a,b)=> new Date(b.updatedAt).getTime()-new Date(a.updatedAt).getTime());
}

export function getCurrentId(): string | null { return localStorage.getItem(CUR); }
export function setCurrentId(id: string | null) { id ? localStorage.setItem(CUR, id) : localStorage.removeItem(CUR); }

export function createAtendimento(): Atendimento {
  const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now());
  const now = new Date().toISOString();
  const novo: Atendimento = { id, title: "Novo atendimento", messages: [], createdAt: now, updatedAt: now, patientId: null, saved: false };
  const list = listAtendimentos(); list.unshift(novo); saveAll(list);
  setCurrentId(id);
  return novo;
}

export function getAtendimento(id: string): Atendimento | null {
  return listAtendimentos().find(x => x.id === id) || null;
}

export function addMensagem(id: string, msg: Mensagem) {
  const list = listAtendimentos();
  const idx = list.findIndex(x=>x.id===id);
  if (idx === -1) return;
  const a = { ...list[idx] };

  if (a.messages.length === 0 && msg.role === "user") {
    const primeira = msg.content.trim().replace(/\s+/g," ").slice(0,60);
    a.title = primeira || "Atendimento";
  }

  a.messages.push(msg);
  a.updatedAt = new Date().toISOString();
  list[idx] = a; saveAll(list);
}

export function renameAtendimento(id: string, novoNome: string) {
  const list = listAtendimentos();
  const idx = list.findIndex(x=>x.id===id);
  if (idx === -1) return;
  list[idx].title = (novoNome || "").trim() || list[idx].title;
  list[idx].updatedAt = new Date().toISOString();
  saveAll(list);
}

export function assignPatient(id: string, patientId: string | null) {
  const list = listAtendimentos();
  const idx = list.findIndex(x=>x.id===id);
  if (idx === -1) return;
  list[idx].patientId = patientId;
  // ao vincular paciente, considera “salvo” implicitamente
  if (patientId) list[idx].saved = true;
  list[idx].updatedAt = new Date().toISOString();
  saveAll(list);
}

export function setSaved(id: string, saved: boolean) {
  const list = listAtendimentos();
  const idx = list.findIndex(x=>x.id===id);
  if (idx === -1) return;
  list[idx].saved = saved;
  list[idx].updatedAt = new Date().toISOString();
  saveAll(list);
}

export function removeAtendimento(id: string) {
  const list = listAtendimentos().filter(x=>x.id!==id);
  saveAll(list);
  const cur = getCurrentId(); if (cur === id) setCurrentId(list[0]?.id || null);
}
